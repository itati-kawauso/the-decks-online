<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE DECKS Online v1.1</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #2c3e50; color: white; display: flex; flex-direction: column; align-items: center; margin: 0; padding-bottom: 20px;}
        #connection-panel { background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; margin: 20px; border: 2px solid #f1c40f; text-align: center; width: 90%; max-width: 400px; }
        
        /* åŸºæœ¬éè¡¨ç¤ºã€started=trueã§flexã¸ */
        #game-board, #game-controls, #game-log { display: none; }
        
        #game-board { width: 95%; max-width: 1000px; flex-direction: column; gap: 10px; margin-top: 20px;}
        .player-area { border: 2px solid #7f8c8d; padding: 10px; border-radius: 10px; background: #34495e; position: relative; transition: 0.3s; }
        .active-area { border-color: #f1c40f; box-shadow: 0 0 20px rgba(241, 196, 15, 0.4); }
        .stats { display: flex; justify-content: space-around; font-weight: bold; margin-bottom: 5px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 5px; font-size: 13px;}
        .style-display { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; min-height: 20px; justify-content: center; }
        .style-chip { background: #f1c40f; color: #000; font-size: 9px; padding: 2px 6px; border-radius: 10px; font-weight: bold; cursor: help; border: 1px solid #d4ac0d; }
        .field, .hand { display: flex; flex-wrap: wrap; gap: 8px; min-height: 110px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; margin-top: 5px; align-items: center; justify-content: center;}
        .card { width: 60px; height: 85px; background: white; color: black; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; border: 3px solid transparent; user-select: none; transition: 0.2s; position: relative; }
        .card.red { color: #e74c3c; }
        .card.back { background: #2980b9 !important; border-color: #3498db; }
        .card.tapped { transform: rotate(10deg); opacity: 0.6; background: #bdc3c7; }
        .card.selected { border-color: #3498db; transform: translateY(-8px); box-shadow: 0 5px 15px rgba(52, 152, 219, 0.6); }
        .card.spell-main { border-color: #9b59b6; box-shadow: 0 0 15px #9b59b6; }
        .card.can-target { border-color: #e67e22; animation: blink 0.8s infinite; }
        @keyframes blink { 0% { box-shadow: 0 0 5px #e67e22; } 50% { box-shadow: 0 0 15px #e67e22; } 100% { box-shadow: 0 0 5px #e67e22; } }
        .suit { font-size: 20px; }
        .trash-list { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; padding: 10px; }
        .controls { margin: 15px; flex-wrap: wrap; gap: 8px; background: #1a252f; padding: 15px; border-radius: 10px; width: 95%; max-width: 980px; justify-content: center;}
        .log-container { width: 95%; max-width: 1000px; height: 180px; background: #000; border: 2px solid #7f8c8d; border-radius: 5px; overflow-y: scroll; padding: 10px; box-sizing: border-box; }
        .log-entry { margin-bottom: 4px; font-family: monospace; font-size: 11px; border-bottom: 1px solid #222; }
        .log-sys { color: #00ff00; }
        .log-atk { color: #ff4d4d; font-weight: bold; }
        .log-spl { color: #9b59b6; }
        .log-ai { color: #ff9f43; }
        button { padding: 8px 12px; cursor: pointer; font-weight: bold; border-radius: 5px; border: none; background: #ecf0f1; transition: background 0.2s; }
        button:hover { background: #bdc3c7; }
        /* Undoãƒœã‚¿ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        button.undo-btn { background: #95a5a6; color: white; }
        button.undo-btn:hover { background: #7f8c8d; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        button.primary { background: #f1c40f; color: #000; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 500; flex-direction: column; align-items: center; justify-content: center; }
        .modal-content { background: #34495e; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #f1c40f; max-height: 90vh; overflow-y: auto; width: 480px; position: relative;}
        .style-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 15px 0; }
        .style-option { background: rgba(0,0,0,0.3); padding: 6px; border-radius: 5px; display: flex; align-items: center; font-size: 10px; text-align: left;}
        .direct-attack-btn { background: #e74c3c; color: white; padding: 10px; border-radius: 5px; cursor: pointer; display: none; margin: 5px auto; border: 2px solid white;}
        button.active-mode { background: #f1c40f !important; color: #000 !important; box-shadow: 0 0 15px rgba(241, 196, 15, 0.6);transform: scale(1.05); }
    </style>
</head>
<body>

<div id="audio-controls" style="position: fixed; top: 10px; right: 10px; z-index: 1000; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 5px;">
    <button onclick="toggleBGM()" id="bgm-toggle-btn" style="font-size: 12px; padding: 5px;">ğŸµ BGM: OFF</button>
    <input type="range" id="bgm-volume" min="0" max="1" step="0.1" value="0.3" onchange="changeVolume(this.value)" style="vertical-align: middle; width: 60px;">
</div>

<h1>THE DECKS Online</h1>

<div id="connection-panel">
    <div id="status">å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰é¸æŠ</div>
    <div id="my-id-display" style="margin: 10px 0; font-weight: bold; color: #f1c40f; word-break: break-all;"></div>
    <button id="copy-btn" onclick="copyMyID()" style="display:none; font-size: 10px; margin-bottom: 15px; background: #34495e; color: #f1c40f; border: 1px solid #f1c40f; padding: 5px 10px; border-radius: 5px;">IDã‚’ã‚³ãƒ”ãƒ¼</button>
    
    <div style="display: flex; flex-direction: column; gap: 10px;">
        <button onclick="startSoloMode()" class="primary" style="padding: 12px;">ä¸€äººã§éŠã¶ (vs AI)</button>
        <hr style="width: 100%; border: 0; border-top: 1px solid #444;">
        <button onclick="hostGame()">éƒ¨å±‹ã‚’ä½œã‚‹ (Host)</button>
        <div style="margin-top: 5px;">
            <input id="join-id" placeholder="Hostã®IDã‚’å…¥åŠ›" style="padding: 8px; width: 60%;">
            <button onclick="joinGame()">å‚åŠ </button>
        </div>
        <hr style="width: 100%; border: 0; border-top: 1px solid #444;">
        <button style="background: #3498db; color: white; padding: 10px;" onclick="openRuleBook()">ğŸ“– ãƒ«ãƒ¼ãƒ«PDFã‚’ç¢ºèªã™ã‚‹</button>
    </div>
</div>

<div id="mode-selection-modal" class="modal">
    <div class="modal-content">
        <h2>ãƒ«ãƒ¼ãƒ«è¨­å®š</h2>
        <div id="mode-options" style="display: flex; gap: 10px; justify-content: center;">
            <button class="primary" onclick="requestRuleMode('basic')">åŸºæœ¬ãƒ«ãƒ¼ãƒ«ã®ã¿</button>
            <button class="primary" onclick="requestRuleMode('style')">æ¡ç”¨å‹ãƒ«ãƒ¼ãƒ«ã‚ã‚Š</button>
        </div>
        <p id="guest-wait-msg" style="display:none; color:#f1c40f; margin-top:20px; font-weight: bold;">HostãŒãƒ«ãƒ¼ãƒ«ã‚’é¸æŠä¸­ã§ã™...</p>
    </div>
</div>

<div id="setup-modal" class="modal">
    <div class="modal-content">
        <h2>ã‚¹ã‚¿ã‚¤ãƒ«é¸æŠ (SPä¸Šé™: 4)</h2>
        <p>æ®‹ã‚ŠSP: <span id="remaining-sp" style="font-weight:bold; color:#f1c40f;">4</span></p>
        <div id="style-list" class="style-grid"></div>
        <button id="style-ready-btn" class="primary" onclick="readyWithStyles()">æº–å‚™å®Œäº†</button>
        <p id="waiting-msg" style="display:none; color:#f1c40f; margin-top:10px;">ç›¸æ‰‹ã®æº–å‚™ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
    </div>
</div>

<div id="joker-modal" class="modal"><div class="modal-content"><h3>JOKERå±æ€§é¸æŠ</h3><button class="primary" onclick="resolveJoker('red')">èµ¤ã¨ã—ã¦ä½¿ã†</button><button class="primary" onclick="resolveJoker('black')">é»’ã¨ã—ã¦ä½¿ã†</button></div></div>
<div id="red-spell-modal" class="modal"><div class="modal-content"><h3>åŠ¹æœé¸æŠ</h3><button class="primary" onclick="resolveRedChoice('DRAW')">1ãƒ‰ãƒ­ãƒ¼</button><button class="primary" onclick="resolveRedChoice('RECOVER')">å¢“åœ°å›å</button></div></div>
<div id="trash-modal" class="modal"><div class="modal-content"><h3>å›åã‚«ãƒ¼ãƒ‰é¸æŠ</h3><div id="trash-display" class="trash-list"></div></div></div>
<div id="bounce-modal" class="modal"><div class="modal-content"><h3>å¯¾è±¡ã‚’é¸æŠ(ãƒã‚¦ãƒ³ã‚¹)</h3><div id="bounce-display" class="trash-list"></div></div></div>

<div id="game-over-modal" class="modal">
    <div class="modal-content">
        <h2 id="winner-text"></h2>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="primary" onclick="requestRestart()">åŒã˜ãƒ«ãƒ¼ãƒ ã§å†æˆ¦</button>
            <button onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
        </div>
    </div>
</div>

<!-- å…ˆæ”»ãƒ»å¾Œæ”»é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="turn-order-modal" class="modal">
    <div class="modal-content">
        <h2 id="turn-order-text"></h2>
        <p style="color: #f1c40f;">å¯¾å±€ã‚’é–‹å§‹ã—ã¾ã™</p>
        <button class="primary" onclick="closeTurnModal()">OK</button>
    </div>
</div>

<div id="mode-text" style="color:#f1c40f; font-weight:bold; height: 20px; margin-bottom:5px;"></div>

<div id="game-board">
    <div id="opp-area" class="player-area">
        <div class="stats">Guest | Deck: <span id="opp-deck">0</span> | AP: <span id="opp-ap">0</span> | Trash: <span id="opp-trash">0</span></div>
        <div id="opp-styles-display" class="style-display"></div>
        <button id="direct-btn" class="direct-attack-btn" onclick="executeDirectAttack()">ç›´æ¥æ”»æ’ƒï¼</button>
        <div id="opp-field" class="field"></div>
        <div id="opp-hand" class="hand"></div>
    </div>
    <div id="my-area" class="player-area">
        <div class="stats">Host | Deck: <span id="my-deck">0</span> | AP: <span id="my-ap">0</span> | Trash: <span id="my-trash">0</span></div>
        <div id="my-styles-display" class="style-display"></div>
        <div id="my-field" class="field"></div>
        <div id="my-hand" class="hand"></div>
    </div>
</div>

<div class="controls" id="game-controls">
    <button id="btn-SUMMON" onclick="setMode('SUMMON')">æ‹›é›†(1AP)</button>
    <button id="btn-SPELL" onclick="setMode('SPELL')">ã‚¹ãƒšãƒ«(1AP)</button>
    <button id="btn-ATTACK" onclick="setMode('ATTACK')">æ”»æ’ƒ(1AP)</button>
    <button id="btn-WITHDRAW" onclick="setMode('WITHDRAW')">æ’¤é€€(1~2AP)</button>
    <button id="btn-UNDO" class="undo-btn" onclick="requestUndo()">1æ‰‹æˆ»ã‚‹(<span id="undo-count">3</span>)</button>
    <button class="primary" id="btn-END" onclick="endTurn()">ã‚¿ãƒ¼ãƒ³çµ‚äº†</button>
    <button style="background: #3498db; color: white;" onclick="openRuleBook()">ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯</button>
    <button style="background: #e74c3c; color: white;" onclick="requestRestart()">å†èµ·å‹•</button>
</div>
<div id="game-log" class="log-container"></div>

<script>
const SUITS = { S: 'â™ ', H: 'â™¥', C: 'â™£', D: 'â™¦', J: 'â˜…' };
const STYLES_DEF = [
    {id:"aceShot", name:"ã‚¨ãƒ¼ã‚¹ã‚·ãƒ§ãƒƒãƒˆ", sp:1, desc:"Aæ’¤é€€æ™‚ç›¸æ‰‹ã«3ãƒ€ãƒ¡"},
    {id:"bukkumi2", name:"ã¶ã£ã“ã¿ãƒ„ãƒ¼", sp:1, desc:"2æ’ƒç ´æ™‚AP+1"},
    {id:"spy3", name:"ã‚¹ãƒ‘ã‚¤ã‚¹ãƒªãƒ¼", sp:1, desc:"3æ”»æ’ƒæ™‚ç›¸æ‰‹æ‰‹æœ­ç¢ºèª"},
    {id:"shield4", name:"ç›¾ã®å››", sp:1, desc:"4ãŒã„ã‚Œã°ä»–ã¯æ”»æ’ƒä¸å¯"},
    {id:"bond5", name:"5ã®çµæŸ", sp:1, desc:"5ãŒ2ä½“ä»¥ä¸Šãªã‚‰æ•°å€¤10"},
    {id:"barikata6", name:"ãƒãƒªã‚«ã‚¿ã‚·ãƒƒã‚¯ã‚¹", sp:1, desc:"6ã¯åŒè‰²ç­‰ä»¥å¤–ä¸å£Š"},
    {id:"lucky7", name:"ãƒ©ãƒƒã‚­ãƒ¼ã‚»ãƒ–ãƒ³", sp:1, desc:"7æ”»æ’ƒæ™‚å±±æœ­å›å¾©"},
    {id:"noCost8", name:"ãƒãƒ¼ã‚³ã‚¹ã‚¨ã‚¤ãƒˆ", sp:1, desc:"8ã‚¹ãƒšãƒ«ãŒã‚³ã‚¹ãƒˆ0"},
    {id:"punch9", name:"ãƒŠã‚¤ãƒ³ãƒ‘ãƒ³ãƒ", sp:1, desc:"9æ‹›é›†æ™‚1APã§ãƒã‚¦ãƒ³ã‚¹"},
    {id:"heavy10", name:"åã®é‡åœ§", sp:1, desc:"æ•µå”åŠ›æˆ¦ã«+1AP"},
    {id:"assassinJ", name:"ã‚¢ã‚µã‚·ãƒ³ã‚¸ãƒ£ãƒƒã‚¯", sp:1, desc:"Jã®æ”»æ’ƒAP0"},
    {id:"queenOrder", name:"ã‚¯ã‚¤ãƒ¼ãƒ³ã‚ºã‚ªãƒ¼ãƒ€ãƒ¼", sp:1, desc:"Qã‚¹ãƒšãƒ«æ™‚2ãƒ€ãƒ¡"},
    {id:"kingAura", name:"ç‹ã®å¨åœ§", sp:3, desc:"æ•µæ‹›é›†ã«2AP"},
    {id:"suitSync", name:"ã‚¹ãƒ¼ãƒˆé€£æº", sp:1, desc:"åŒã‚¹ãƒ¼ãƒˆãªã‚‰æ•°å€¤+2"},
    {id:"blackCurse", name:"é»’ã®å‘ªã„", sp:3, desc:"é»’ã‚¹ãƒšãƒ«ç ´å£Šæ™‚1ãƒ€ãƒ¡"},
    {id:"redHeal", name:"èµ¤ã®ç™’ã—", sp:3, desc:"èµ¤ã‚¹ãƒšãƒ«æ™‚å±±æœ­å›å¾©"}
];
// --- BGMè¨­å®š ---
const bgm = new Audio('BGM.mp3'); // åŒã˜éšå±¤ã«bgm.mp3ãŒã‚ã‚‹å ´åˆ
bgm.loop = true;                 // ãƒ«ãƒ¼ãƒ—å†ç”Ÿ
bgm.volume = 0.3;                // åˆæœŸéŸ³é‡
let isBgmPlaying = false;

function toggleBGM() {
    if (isBgmPlaying) {
        bgm.pause();
        document.getElementById('bgm-toggle-btn').innerText = "ğŸµ BGM: OFF";
    } else {
        bgm.play().catch(e => console.log("å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ã§ã™ï¼‰"));
        document.getElementById('bgm-toggle-btn').innerText = "ğŸµ BGM: ON";
    }
    isBgmPlaying = !isBgmPlaying;
}

function changeVolume(val) {
    bgm.volume = val;
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã«è‡ªå‹•ã§å†ç”Ÿé–‹å§‹ã™ã‚‹é–¢æ•°
function startBgmAutomatically() {
    if (!isBgmPlaying) {
        toggleBGM();
    }
}

let peer, conn, isHost = false, isSolo = false, myRole = null; 
let gameState = { p1: null, p2: null, turn: 1, started: false, gameOver: false, ruleMode: null, winner: null, history: [] };
let myStyles = [], oppStyles = [], myReady = false, oppReady = false;
let currentMode = 'IDLE', selectedCards = [], spellMainIdx = null;

peer = new Peer();
peer.on('open', id => { document.getElementById('my-id-display').innerText = "ã‚ãªãŸã®ID: " + id; document.getElementById('copy-btn').style.display='inline-block'; });
peer.on('connection', c => { conn = c; isHost = true; isSolo = false; myRole = 'p1'; setupConn(); });

function copyMyID() { const id = peer.id; if (id) { navigator.clipboard.writeText(id).then(() => alert("IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ")); } }

function startSoloMode() {
    startBgmAutomatically(); // ã“ã‚Œã‚’è¿½åŠ 
    isSolo = true; isHost = true; myRole = 'p1';
    resetLocalStates(); resetUIVisibility();
    document.getElementById('connection-panel').style.display = 'none';
    document.getElementById('mode-selection-modal').style.display = 'flex';
}

function hostGame() { 
    startBgmAutomatically(); // ã“ã‚Œã‚’è¿½åŠ 
    isSolo = false; 
    document.getElementById('status').innerText = "æ¥ç¶šå¾…æ©Ÿä¸­..."; 
}

function joinGame() { 
    startBgmAutomatically(); // ã“ã‚Œã‚’è¿½åŠ 
    const id = document.getElementById('join-id').value; 
    if(id) { conn = peer.connect(id); isSolo = false; isHost = false; myRole = 'p2'; setupConn(); } 
}

function setupConn() {
    conn.on('open', () => {
        document.getElementById('connection-panel').style.display = 'none';
        resetLocalStates();
        document.getElementById('mode-selection-modal').style.display = 'flex';
        if(!isHost) { document.getElementById('mode-options').style.display = 'none'; document.getElementById('guest-wait-msg').style.display = 'block'; }
    });
    conn.on('data', data => handleData(data));
}

function handleData(data) {
    if(!data) return;
    switch(data.type) {
        case 'RULE_SELECT':
            gameState.ruleMode = data.payload;
            document.getElementById('mode-selection-modal').style.display = 'none';
            if(gameState.ruleMode === 'style') { document.getElementById('setup-modal').style.display = 'flex'; renderStyleSelection(); }
            else if(isHost) initGame();
            break;
        case 'READY_STYLES':
            if(isHost) { oppStyles = data.payload.styles; oppReady = true; checkHostStart(); }
            break;
        case 'SYNC':
            gameState = data.payload;
            if(gameState.started) {
                transitionToGame();
            } else {
                // å†æˆ¦ãƒ»åˆæœŸåŒ–æ™‚ï¼ˆstarted=falseï¼‰
                // 1. å…¨ã¦ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å¼·åˆ¶çš„ã«é–‰ã˜ã‚‹ï¼ˆã“ã‚ŒãŒé‡è¦ï¼‰
                document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
                
                // 2. åŸºæœ¬ç”»é¢ã‚’éè¡¨ç¤º
                document.getElementById('game-board').style.display = 'none';
                document.getElementById('game-controls').style.display = 'none';
                
                // 3. ãƒ«ãƒ¼ãƒ«ãŒæœªæ±ºå®šãªã‚‰ãƒ«ãƒ¼ãƒ«é¸æŠã‚’è¡¨ç¤º
                if (!gameState.ruleMode) {
                    document.getElementById('mode-selection-modal').style.display = 'flex';
                    if(!isHost) {
                        document.getElementById('mode-options').style.display = 'none';
                        document.getElementById('guest-wait-msg').style.display = 'block';
                    }
                }
            }
            if(gameState.gameOver) showGameOver();
            updateUI();
            break;
            if(gameState.gameOver) showGameOver();
            updateUI();
            break;
        case 'LOG': writeLog(data.payload.msg, data.payload.type); break;
        case 'ACTION':
            if(isHost) {
                if(data.payload.type === 'END_TURN') endTurn();
                else if(data.payload.type === 'RESTART') requestRestart();
                else if(data.payload.type === 'UNDO') executeUndo(); // ã“ã‚Œã‚’è¿½åŠ 
                else executeAction(data.payload.type, data.payload.params);
                sync(); // å®Ÿè¡Œå¾Œã«ã‚²ã‚¹ãƒˆã¸åŒæœŸ
            }
            break;
    }
}

function requestRuleMode(m) {
    if(!isHost) return;
    if(isSolo) {
        gameState.ruleMode = m;
        document.getElementById('mode-selection-modal').style.display = 'none';
        if(m === 'style') {
            oppStyles = []; let sp = 0; let pool = [...STYLES_DEF].sort(() => Math.random()-0.5);
            pool.forEach(s => { if(sp + s.sp <= 4) { oppStyles.push(s.id); sp += s.sp; } });
            oppReady = true; document.getElementById('setup-modal').style.display = 'flex'; renderStyleSelection();
        } else initGame();
    } else {
        send('RULE_SELECT', m);
        handleData({type:'RULE_SELECT', payload: m});
    }
}

function renderStyleSelection() {
    const list = document.getElementById('style-list'); list.innerHTML = '';
    STYLES_DEF.forEach(s => {
        const div = document.createElement('div'); div.className = 'style-option';
        div.innerHTML = `<input type="checkbox" class="style-check" value="${s.id}" data-sp="${s.sp}">
                         <div style="margin-left:5px;"><b>${s.name}</b>(${s.sp}SP)<br>${s.desc}</div>`;
        div.querySelector('input').onchange = (e) => {
            let total = 0; document.querySelectorAll('.style-check:checked').forEach(ck => { total += parseInt(ck.getAttribute('data-sp')); });
            if(total > 4) { e.target.checked = false; total -= parseInt(e.target.getAttribute('data-sp')); alert("SPä¸Šé™ã¯4ã§ã™"); }
            document.getElementById('remaining-sp').innerText = 4 - total;
        };
        list.appendChild(div);
    });
}

function readyWithStyles() {
    myStyles = Array.from(document.querySelectorAll('.style-check:checked')).map(c => c.value);
    myReady = true;
    if(isSolo) { initGame(); }
    else if(!isHost) {
        send('READY_STYLES', { styles: myStyles });
        document.getElementById('style-ready-btn').style.display = 'none';
        document.getElementById('waiting-msg').style.display = 'block';
    } else { checkHostStart(); }
}

function checkHostStart() {
    if(isHost && myReady && (isSolo || oppReady)) { 
        initGame(); 
    } else {
        // ãƒ›ã‚¹ãƒˆè‡ªèº«ãŒæº–å‚™å®Œäº†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®ã¿ã€å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãƒœã‚¿ãƒ³ã‚’éš ã™
        if (myReady) {
            document.getElementById('style-ready-btn').style.display = 'none';
            document.getElementById('waiting-msg').style.display = 'block';
        }
    }
}
// initGameé–¢æ•°ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£
function initGame() {
    if(!isHost) return;
    gameState.started = true;
    gameState.gameOver = false;
    gameState.winner = null;
    gameState.history = []; 

    // --- ä¿®æ­£ç®‡æ‰€ï¼šå…ˆæ”»(1) or å¾Œæ”»(2) ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®š ---
    gameState.turn = Math.random() < 0.5 ? 1 : 2;

    gameState.p1 = { name:"Host", deck:createDeck(['S','H']), hand:[], field:[], trash:[], ap:0, styles: myStyles, undoLeft: 3 };
    gameState.p2 = { name:(isSolo?"Guest (AI)":"Guest"), deck:createDeck(['C','D']), hand:[], field:[], trash:[], ap:0, styles: oppStyles, undoLeft: 3 };
    for(let i=0; i<3; i++) { gameState.p1.hand.push(gameState.p1.deck.pop()); gameState.p2.hand.push(gameState.p2.deck.pop()); }
    
    transitionToGame(); 
    logToBoth("--- GAME START ---", "sys"); 
    startTurn();
}

function saveHistory() {
    if (!gameState.history) gameState.history = [];
    const snapshot = {
        p1: JSON.parse(JSON.stringify(gameState.p1)),
        p2: JSON.parse(JSON.stringify(gameState.p2)),
        turn: gameState.turn
    };
    gameState.history.push(snapshot);
    if (gameState.history.length > 10) gameState.history.shift();
}

function requestUndo() {
    const p = (gameState.turn === 1 ? gameState.p1 : gameState.p2);
    const historyLen = gameState.history ? gameState.history.length : 0;
    
    if (p.undoLeft <= 0 || historyLen === 0) {
        logToBoth("æˆ»ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“", "sys");
        return;
    }

    if (isHost) {
        executeUndo();
        if(!isSolo) sync();
    } else {
        send('ACTION', {type: 'UNDO'}); // ãƒ›ã‚¹ãƒˆã«Undoã‚’ä¾é ¼
    }
}

function executeUndo() {
    if (!gameState.history || gameState.history.length === 0) return;
    
    // ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ®‹ã‚ŠUndoå›æ•°ã‚’ä¿æŒã—ã¦ãŠã
    const pBefore = (gameState.turn === 1 ? gameState.p1 : gameState.p2);
    const nextUndoCount = pBefore.undoLeft - 1;

    // å±¥æ­´ã‹ã‚‰ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–ã‚Šå‡ºã™
    const prevState = gameState.history.pop();
    
    // ã‚¿ãƒ¼ãƒ³ã‚’è·¨ã„ã§ã®Undoã¯ç¦æ­¢ï¼ˆå‰ã®ã‚¿ãƒ¼ãƒ³ã®æœ€å¾Œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯æˆ»ã›ãªã„ï¼‰
    if (prevState.turn !== gameState.turn) {
        logToBoth("å‰ã®ã‚¿ãƒ¼ãƒ³ã®è¡Œå‹•ã¯æˆ»ã›ã¾ã›ã‚“", "sys");
        // å±¥æ­´ã‚’æˆ»ã™ï¼ˆpopã—ã¦ã—ã¾ã£ãŸã®ã§ã€æˆ»ã•ãªã„ã¨å±¥æ­´ãŒæ¶ˆãˆã‚‹ï¼‰
        gameState.history.push(prevState); 
        return;
    }

    // çŠ¶æ…‹ã‚’å¾©å…ƒ
    gameState.p1 = prevState.p1;
    gameState.p2 = prevState.p2;
    gameState.turn = prevState.turn;

    // Undoå›æ•°ã ã‘ã¯ã€Œæ¸›ã‚‰ã—ãŸå¾Œã®å€¤ã€ã‚’é©ç”¨ã™ã‚‹
    const pAfter = (gameState.turn === 1 ? gameState.p1 : gameState.p2);
    pAfter.undoLeft = nextUndoCount;

    logToBoth(`${pAfter.name}: è¡Œå‹•ã‚’ä¸€ã¤æˆ»ã—ã¾ã—ãŸï¼ˆæ®‹ã‚Š${pAfter.undoLeft}å›ï¼‰`, "sys");
    resetMode();
    updateUI();
}

// requestAction ã®å†’é ­ã§ä¿å­˜ã‚’è¡Œã†
function requestAction(type, params) {
    if(isHost) {
        executeAction(type, params); // ç›´æ¥å®Ÿè¡Œã¸
        if(!isSolo) sync();
    } else {
        send('ACTION', {type, params});
    }
}

function startTurn() {
    if(!isHost) return;
    const p = (gameState.turn === 1 ? gameState.p1 : gameState.p2);
    if(p.deck.length < 2) { finishGame((gameState.turn===1?"p2":"p1"), p.name + " å±±æœ­åˆ‡ã‚Œï¼"); return; }
    for(let i=0; i<2; i++) p.hand.push(p.deck.pop());
    p.ap = Math.min(p.hand.length, 10);
    p.field.forEach(c => { c.tapped = false; });
    logToBoth(`--- ${p.name} ã‚¿ãƒ¼ãƒ³é–‹å§‹ ---`, "sys"); sync();
    if(isSolo && gameState.turn === 2) setTimeout(runAiTurn, 1000);
}

let turnModalShown = false; // äºŒé‡è¡¨ç¤ºé˜²æ­¢ç”¨ãƒ•ãƒ©ã‚°

function transitionToGame() {
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä¸€åº¦ã ã‘è¡¨ç¤ºã™ã‚‹ãŸã‚ã®å‡¦ç†
    if (!turnModalShown) {
        const isMyTurn = (gameState.turn === (myRole === 'p1' ? 1 : 2));
        const turnText = document.getElementById('turn-order-text');
        
        if (isMyTurn) {
            turnText.innerText = "ã‚ãªãŸãŒå…ˆæ”»ï¼";
            turnText.style.color = "#f1c40f"; // é‡‘è‰²
        } else {
            turnText.innerText = "ã‚ãªãŸã¯å¾Œæ”»ï¼";
            turnText.style.color = "#ffffff"; // ç™½è‰²
        }
        document.getElementById('turn-order-modal').style.display = 'flex';
        turnModalShown = true;
    }

    document.querySelectorAll('.modal').forEach(m => { 
        // turn-order-modal ä»¥å¤–ã‚’éš ã™
        if(!['joker-modal','red-spell-modal','trash-modal','bounce-modal','game-over-modal','turn-order-modal'].includes(m.id)) m.style.display='none'; 
    });
    document.getElementById('game-board').style.display = 'flex';
    document.getElementById('game-controls').style.display = 'flex';
    document.getElementById('game-log').style.display = 'block';
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°ã‚’è¿½åŠ 
function closeTurnModal() {
    document.getElementById('turn-order-modal').style.display = 'none';
    // BGMã®å†ç”Ÿã‚‚ã“ã“ã§è¡Œã†ã¨ã‚ˆã‚Šã‚¹ãƒ ãƒ¼ã‚ºã§ã™
    if (typeof startBgmAutomatically === "function") startBgmAutomatically();
}
    
function getRankText(rank) {
    if (rank === 14) return 'JOK';
    if (rank === 1) return 'A';
    if (rank === 11) return 'J';
    if (rank === 12) return 'Q';
    if (rank === 13) return 'K';
    return rank;
}
    
function executeAction(type, params) {
    saveHistory(); // å…¨ã¦ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã€Œå®Ÿè¡Œç›´å‰ã€ã®çŠ¶æ…‹ã‚’è‡ªå‹•ä¿å­˜
    const p = (gameState.turn === 1 ? gameState.p1 : gameState.p2);
    const opp = (gameState.turn === 1 ? gameState.p2 : gameState.p1);

    if(type === 'SUMMON' && p.ap >= params.cost) {
        let c = p.hand.splice(params.idx, 1)[0]; c.tapped = false; p.field.push(c); p.ap -= params.cost;
        logToBoth(`${p.name}: ${getCardName(c)} æ‹›é›†`, "usr");
        if(c.rank === 9 && p.styles.includes('punch9') && p.ap >= 1 && opp.field.length > 0) { if(myRole === (gameState.turn===1?'p1':'p2')) showBounceModal(opp.field); }
    }
    else if(type === 'WITHDRAW' && p.ap >= params.cost) {
        let c = p.field.splice(params.idx, 1)[0];
        c.tapped = false;
        p.deck.push(c);
        p.ap -= params.cost; // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸã‚³ã‚¹ãƒˆã‚’å·®ã—å¼•ã
        logToBoth(`${p.name}: ${getCardName(c)} æ’¤é€€ (${params.cost}APæ¶ˆè²»)`, "usr");
        if(c.rank === 1 && p.styles.includes('aceShot')) applyDamage(opp, 3);
    }
    else if(type === 'COMBAT') {
        const atk = params.atkIdxs.map(i => p.field[i]); 
        const def = opp.field[params.defIdx];
        
        // ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã¯ç„¡è‰²ã®ãŸã‚ã€ã„ãšã‚Œã‹ãŒã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ãªã‚‰ã€ŒåŒè‰²ã€åˆ¤å®šã¯å¿…ãšfalseã«ãªã‚‹
        const same = (!atk[0].isJoker && !def.isJoker && atk[0].red === def.red);
        
        const power = atk.reduce((s,c)=>s+getEffectiveRank(c,p), 0);
        const dPower = getEffectiveRank(def, opp);
        
        atk.forEach(a=>a.tapped=true); 
        p.ap -= params.apCost;

        logToBoth(`æˆ¦é—˜: ${atk.map(a=>getCardName(a)).join("+")}(è¨ˆ${power}) VS ${getCardName(def)}(${dPower})`, "atk");
        
        let canKill = false;
        let damage = 0;

        if (def.isJoker) {
            // ã€ä¿®æ­£ã€‘ç›¸æ‰‹ãŒã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã®å ´åˆï¼šç•°è‰²æˆ¦é—˜ã®è‡ªå‹•ç ´å£Šã¯é©ç”¨ã•ã‚Œãªã„
            // æ•°å€¤ã®ã¿ã‚’å‚ç…§ã—ã€åˆè¨ˆå€¤ãŒ14ä»¥ä¸Šï¼ˆã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã®æ•°å€¤ï¼‰ã®æ™‚ã®ã¿æ’ƒç ´
            if (power >= 14) {
                canKill = true;
                damage = 0; // ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼æ’ƒç ´æ™‚ã¯ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã‚Šå¸¸ã«0ãƒ€ãƒ¡ãƒ¼ã‚¸
            }
        } else if (same) {
            // åŒè‰²æˆ¦é—˜ï¼šæ•°å€¤æ¯”è¼ƒ
            if (power >= dPower) {
                canKill = true;
                damage = 1; // åŒè‰²å‹åˆ©ã¯1ãƒ€ãƒ¡ãƒ¼ã‚¸
            }
        } else {
            // ç•°è‰²æˆ¦é—˜ï¼šæ•°å€¤ã«é–¢ã‚ã‚‰ãšç›¸æ‰‹ã‚’ç ´å£Š
            canKill = true;
            damage = 0; // ç•°è‰²æˆ¦é—˜ã¯0ãƒ€ãƒ¡ãƒ¼ã‚¸
            
            // ä¾‹å¤–ï¼šãƒãƒªã‚«ã‚¿ã‚·ãƒƒã‚¯ã‚¹ï¼ˆ6ã¯åŒè‰²ãƒ»JOKãƒ»é»’ã‚¹ãƒšãƒ«ä»¥å¤–ä¸å£Šï¼‰
            if (def.rank === 6 && opp.styles.includes('barikata6') && !atk.some(x => x.isJoker)) {
                canKill = false;
            }
        }

        if (canKill) {
            let d = opp.field.splice(params.defIdx, 1)[0]; 
            d.tapped = false; 
            opp.trash.push(d);

            if (damage > 0) {
                applyDamage(opp, damage);
            } else {
                logToBoth(`${getCardName(def)} ã‚’ç ´å£Šï¼(ãƒ€ãƒ¡ãƒ¼ã‚¸ 0)`, "atk");
            }

            // åŒè‰²ç›¸æ‰“ã¡ã®å‡¦ç†
            if (same && power === dPower) {
                params.atkIdxs.sort((a,b)=>b-a).forEach(i=>{ 
                    let c = p.field.splice(i,1)[0]; 
                    c.tapped = false; 
                    p.trash.push(c); 
                }); 
                logToBoth("ç›¸æ‰“ã¡ï¼(åŒæ–¹ç ´å£Š)", "atk"); 
            }
            
            // ã¶ã£ã“ã¿ãƒ„ãƒ¼ï¼ˆã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
            if (atk.some(x => x.rank === 2) && p.styles.includes('bukkumi2')) p.ap++;
            
        } else {
            // è¿”ã‚Šè¨ã¡åˆ¤å®šï¼ˆåŒè‰²ã§ãƒ‘ãƒ¯ãƒ¼è² ã‘ã—ãŸå ´åˆã®ã¿ï¼‰
            if (same && power < dPower) {
                params.atkIdxs.sort((a,b)=>b-a).forEach(i=>{ 
                    let c = p.field.splice(i,1)[0]; 
                    c.tapped = false; 
                    p.trash.push(c); 
                });
                logToBoth(`è¿”ã‚Šè¨ã¡ï¼(${p.name}å´ç ´å£Š)`, "atk");
            } else {
                logToBoth("æ’ƒç ´å¤±æ•—ï¼", "atk");
            }
        }
    }
    else if(type === 'DIRECT') { 
        // æ”»æ’ƒé™£ã®ä¸­ã«J(rank 11)ãŒå«ã¾ã‚Œã€ã‹ã¤ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æŒã£ã¦ã„ã‚‹ã‹åˆ¤å®š
        const hasJack = params.idxs.some(i => p.field[i].rank === 11);
        let apCost = (hasJack && p.styles.includes('assassinJ')) ? 0 : 1;

        if (p.ap >= apCost) {
            params.idxs.forEach(i => p.field[i].tapped = true); 
            p.ap -= apCost; 
            logToBoth(`${p.name}: ç›´æ¥æ”»æ’ƒ(2ãƒ€ãƒ¡ãƒ¼ã‚¸) [æ¶ˆè²»AP:${apCost}]`, "atk"); 
            applyDamage(opp, 2); 
        } else {
            logToBoth("APä¸è¶³ã«ã‚ˆã‚Šç›´æ¥æ”»æ’ƒã«å¤±æ•—ã—ã¾ã—ãŸ", "sys");
        }
    }
    else if(type === 'SPELL_MAIN') {
        let mainCard = p.hand[params.idx];
        let removeIndices = params.costIdxs.filter(it => it.area === 'hand').map(it => it.idx);
        removeIndices.push(params.idx);
        removeIndices.sort((a, b) => b - a);
        removeIndices.forEach(idx => {
            let c = p.hand.splice(idx, 1)[0]; c.tapped = false; p.trash.push(c);
        });
        params.costIdxs.filter(it => it.area === 'field').sort((a,b)=>b.idx-a.idx).forEach(it => {
            let c = p.field.splice(it.idx, 1)[0]; c.tapped = false; p.trash.push(c);
        });
        p.ap--;
        logToBoth(`${p.name}: ã‚¹ãƒšãƒ« ${getCardName(mainCard)} ç™ºå‹•`, "spl");
        if(mainCard.rank===12 && p.styles.includes('queenOrder')) applyDamage(opp, 2);
    }
    else if(type === 'SPELL_RED_RESOLVE') {
        const activeP = (gameState.turn === 1 ? gameState.p1 : gameState.p2);
        if(params.choice==='DRAW') { 
            // applyDamageã‚’ä½¿ã‚ãšã«ãƒ‰ãƒ­ãƒ¼å‡¦ç†ã‚’ç›´æ¥è¨˜è¿°ã™ã‚‹ã“ã¨ã§ãƒ€ãƒ¡ãƒ¼ã‚¸è¡¨è¨˜ã‚’å›é¿
            if(activeP.deck.length < 1) {
                finishGame((activeP.name === (isHost ? gameState.p1.name : "Guest") ? "p2" : "p1"), activeP.name + " ã®å±±æœ­åˆ‡ã‚Œ");
                return;
            }
            activeP.hand.push(activeP.deck.pop());
            logToBoth("1æšãƒ‰ãƒ­ãƒ¼!", "spl"); 
        } 
        if(activeP.styles.includes('redHeal') && activeP.trash.length > 0) {
            activeP.deck.push(activeP.trash.pop());
        }
    }
    else if(type === 'SPELL_RECOVER_FINISH') {
        let r = p.trash.splice(params.trashIdx, 1)[0]; r.tapped=false; p.hand.push(r);
        logToBoth(`${p.name}: ${getCardName(r)} ã‚’ãƒˆãƒ©ãƒƒã‚·ãƒ¥ã‹ã‚‰å›å`, "spl");
        if(p.styles.includes('redHeal') && p.trash.length > 0) p.deck.push(p.trash.pop());
    }
    else if(type === 'SPELL_BLACK_RESOLVE') {
        let d = opp.field.splice(params.targetIdx, 1)[0]; d.tapped=false; opp.trash.push(d);
        logToBoth(`${p.name}: é»’ã‚¹ãƒšãƒ«ã§ ${getCardName(d)} ã‚’ç ´å£Š`, "spl");
        if(p.styles.includes('blackCurse')) applyDamage(opp, 1);
    }
    else if(type === 'BOUNCE') { 
        let d = opp.field.splice(params.idx, 1)[0]; d.tapped=false; opp.hand.push(d); 
        p.ap--; 
        logToBoth(`${p.name}: ãƒã‚¦ãƒ³ã‚¹ç™ºå‹•`, "spl"); 
    }

    if(isSolo) updateUI();
}
function handleCardClick(owner, area, idx) {
    if(gameState.gameOver || gameState.turn !== (myRole === 'p1' ? 1 : 2)) return;
    const me = (myRole === 'p1' ? gameState.p1 : gameState.p2);
    const opp = (myRole === 'p1' ? gameState.p2 : gameState.p1);

    if(owner === 'me') {
        if(currentMode === 'SUMMON' && area === 'hand') { 
            const c = (opp.field.some(x=>x.rank===13) && opp.styles.includes('kingAura')) ? 2 : 1; 
            if(me.field.length < 4 && me.ap >= c) { requestAction('SUMMON', {idx, cost: c}); resetMode(); } 
        }
        else if(currentMode === 'WITHDRAW' && area === 'field') {
            // ã‚¿ãƒƒãƒ—çŠ¶æ…‹ãªã‚‰2APã€æœªã‚¿ãƒƒãƒ—ãªã‚‰1AP
            const cost = me.field[idx].tapped ? 2 : 1;
            if(me.ap >= cost) {
                requestAction('WITHDRAW', {idx, cost: cost});
                resetMode();
            } else {
                logToBoth(`APãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼(ã‚¿ãƒƒãƒ—çŠ¶æ…‹ã®æ’¤é€€ã¯2APå¿…è¦ã§ã™)`, "sys");
            }
        }
        else if(currentMode === 'ATTACK' && area === 'field') { 
            if(!me.field[idx].tapped) { 
                const ex = selectedCards.findIndex(s => s.idx === idx && s.area === 'field'); 
                if(ex !== -1) selectedCards.splice(ex, 1); else selectedCards.push({idx, area:'field'}); 
                updateUI(); 
            } 
        }
        else if(currentMode === 'SPELL' && area === 'hand') {
            if(me.ap >= 1) {
                const card = me.hand[idx];
                // é»’ã‚¹ãƒšãƒ«ã®ç©ºæ‰“ã¡ãƒã‚§ãƒƒã‚¯
                if (!card.isJoker && !card.red && opp.field.length === 0) {
                    logToBoth("ç›¸æ‰‹ã®å ´ã«å…µå£«ãŒã„ãªã„ãŸã‚ã€é»’ã‚¹ãƒšãƒ«ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚", "sys");
                    resetMode();
                    return;
                }
                
                spellMainIdx = idx;
                // Aã€ã¾ãŸã¯8(ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨æ™‚)ã¯ã‚³ã‚¹ãƒˆ0
                if(card.isJoker || card.rank === 1 || (card.rank === 8 && me.styles.includes('noCost8'))) {
                    // é‡è¦ï¼šãƒ›ã‚¹ãƒˆå´ã§ã®é…åˆ—æ“ä½œå‰ã«ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’å¤‰æ•°ã«ä¿æŒã™ã‚‹
                    const cardToPlay = me.hand[spellMainIdx];
                    requestAction('SPELL_MAIN', {idx: spellMainIdx, costIdxs: []});
                    handleSpellFollowUp(cardToPlay); 
                } else {
                    currentMode = 'SPELL_COST';
                    updateUI();
                }
            }
        }
        else if(currentMode === 'SPELL_COST') { 
            if(area === 'hand' && idx === spellMainIdx) return; 
            const ex = selectedCards.findIndex(s => s.idx === idx && s.area === area); 
            if(ex !== -1) selectedCards.splice(ex, 1); else selectedCards.push({idx, area}); 
            
            const tot = selectedCards.reduce((s, it) => s + me[it.area][it.idx].rank, 0); 
            const mainCard = me.hand[spellMainIdx];
            
            if(tot >= mainCard.rank - 1) { 
                // é‡è¦ï¼šé…åˆ—ãŒæ“ä½œã•ã‚Œã‚‹å‰ã«å‚ç…§ã‚’ç¢ºå®šã•ã›ã‚‹
                const cardToPlay = mainCard;
                requestAction('SPELL_MAIN', {idx: spellMainIdx, costIdxs: selectedCards}); 
                handleSpellFollowUp(cardToPlay); 
            } else {
                updateUI();
            }
        }
    } else {
        // ç›¸æ‰‹ã‚¨ãƒªã‚¢ã‚¯ãƒªãƒƒã‚¯æ™‚ï¼ˆæ”»æ’ƒãƒ»é»’ã‚¹ãƒšãƒ«å¯¾è±¡é¸æŠï¼‰
        if(currentMode === 'ATTACK' && area === 'field' && selectedCards.length > 0) {
            if(opp.field.some(x=>x.rank===4 && opp.styles.includes('shield4')) && opp.field[idx].rank !== 4) return;
            
            // å”åŠ›æˆ¦ã®è‰²ãƒã‚§ãƒƒã‚¯
            if (selectedCards.length > 1) {
                const cards = selectedCards.map(s => me.field[s.idx]);
                const allSameColor = cards.every(c => c.red === cards[0].red && !c.isJoker);
                if (!allSameColor) {
                    alert("å”åŠ›æˆ¦ã¯åŒè‰²ã®å…µå£«ã®ã¿å¯èƒ½ã§ã™");
                    resetMode();
                    return;
                }
            }

            // --- ã‚³ã‚¹ãƒˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
            let apCost = 1; // åŸºæœ¬ 1AP
            
            // åã®é‡åœ§ (ç›¸æ‰‹ã‚¹ã‚¿ã‚¤ãƒ« & å”åŠ›æˆ¦ãªã‚‰ +1AP)
            if (selectedCards.length > 1 && opp.styles.includes('heavy10')) {
                apCost += 1;
            }

            // ã‚¢ã‚µã‚·ãƒ³ã‚¸ãƒ£ãƒƒã‚¯ (è‡ªåˆ†ã‚¹ã‚¿ã‚¤ãƒ« & æ”»æ’ƒé™£ã«J[11]ãŒã„ã‚Œã° -1AP)
            const includesJack = selectedCards.some(s => me.field[s.idx].rank === 11);
            if (includesJack && me.styles.includes('assassinJ')) {
                apCost -= 1;
            }

            apCost = Math.max(0, apCost); // æœ€å°0AP

            // ã€é‡è¦ã€‘ã“ã“ã§æœ€çµ‚çš„ãªAPãƒã‚§ãƒƒã‚¯
            if(me.ap >= apCost) { 
                requestAction('COMBAT', {atkIdxs: selectedCards.map(s => s.idx), defIdx: idx, apCost}); 
                resetMode(); 
            } else {
                // ã“ã“ã§ã€Œã‚¸ãƒ£ãƒƒã‚¯ã‚’å«ã¾ãªã„æ”»æ’ƒã€ã‚’AP0ã§ã‚„ã‚ã†ã¨ã—ãŸå ´åˆãªã©ã«è­¦å‘ŠãŒå‡ºã‚‹
                logToBoth(`APãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼(ã“ã®æ”»æ’ƒã«ã¯ ${apCost}AP å¿…è¦ã§ã™)`, "sys");
            }
        }
        else if(currentMode === 'SPELL_TARGET' && area === 'field') {
            requestAction('SPELL_BLACK_RESOLVE', {targetIdx: idx});
            resetMode();
        }
    }
}
function updateUI() {
    if(!gameState.started || !gameState.p1) return;
    const me = (myRole === 'p1' ? gameState.p1 : gameState.p2);
    const isMyTurn = (gameState.turn === (myRole === 'p1' ? 1 : 2));
    const opp = (myRole === 'p1' ? gameState.p2 : gameState.p1);
    document.getElementById('my-deck').innerText = me.deck.length; document.getElementById('my-ap').innerText = me.ap; document.getElementById('my-trash').innerText = me.trash.length;
    document.getElementById('opp-deck').innerText = opp.deck.length; document.getElementById('opp-ap').innerText = opp.ap; document.getElementById('opp-trash').innerText = opp.trash.length;
    renderCards('my-hand', me.hand, false, 'me', 'hand', me); renderCards('my-field', me.field, false, 'me', 'field', me);
    renderCards('opp-hand', opp.hand, (!isSolo), 'opp', 'hand', opp); renderCards('opp-field', opp.field, false, 'opp', 'field', opp);
    renderStyleChips('my-styles-display', me.styles); renderStyleChips('opp-styles-display', opp.styles);
        // Undoå›æ•°ã®è¡¨ç¤º
    const undoBtn = document.getElementById('btn-UNDO');
    const historyLen = gameState.history ? gameState.history.length : 0;
    document.getElementById('undo-count').innerText = me.undoLeft || 0;
    
    // å±¥æ­´ãŒã‚ã‚Šã€è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã§ã€ã‹ã¤å›æ•°ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã®ã¿æœ‰åŠ¹
    undoBtn.disabled = (!isMyTurn || gameState.gameOver || (me.undoLeft || 0) <= 0 || historyLen === 0);

    // AIæˆ¦ã§ã‚‚ç›¸æ‰‹ã®æ‰‹æœ­ã¯å¸¸ã«éš ã™ (isBack ã‚’å¸¸ã« true ã«)
    renderCards('opp-hand', opp.hand, true, 'opp', 'hand', opp); 

    document.getElementById('my-area').className = 'player-area' + (isMyTurn ? ' active-area' : '');
    document.getElementById('opp-area').className = 'player-area' + (!isMyTurn ? ' active-area' : '');
    // ç›´æ¥æ”»æ’ƒãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ¡ä»¶: APãŒ1ä»¥ä¸Šå¿…è¦
    document.getElementById('direct-btn').style.display = (isMyTurn && me.ap >= 1 && currentMode === 'ATTACK' && selectedCards.length > 0 && opp.field.length === 0) ? 'block' : 'none';    
    const btns = ['SUMMON', 'SPELL', 'ATTACK', 'WITHDRAW'];
    btns.forEach(id => {
        const b = document.getElementById('btn-' + id);
        b.disabled = (!isMyTurn || gameState.gameOver);
        
        // ãƒã‚¤ãƒ©ã‚¤ãƒˆã®é©ç”¨
        if (currentMode === id || (id === 'SPELL' && currentMode.startsWith('SPELL_'))) {
            b.classList.add('active-mode');
        } else {
            b.classList.remove('active-mode');
        }
    });
    
    if(isSolo) {
        renderCards('opp-hand', gameState.p2.hand, true, 'opp', 'hand', gameState.p2);
    }
    // çµ‚äº†ãƒœã‚¿ãƒ³ã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆä¸è¦
    document.getElementById('btn-END').disabled = (!isMyTurn || gameState.gameOver);
}
function applyDamage(t, a) {
    logToBoth(`${t.name}: ${a}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼(å±±æœ­ã‹ã‚‰${a}æšå¼•ã)`, "atk");
    if(t.deck.length < a) {
        finishGame((t.name === (isHost ? gameState.p1.name : "Guest") ? "p2" : "p1"), t.name + " ã®å±±æœ­åˆ‡ã‚Œ");
        return;
    }
    for(let i=0; i<a; i++) t.hand.push(t.deck.pop());
}

function finishGame(winnerRole, reason) {
    gameState.gameOver = true;
    gameState.winner = winnerRole;
    logToBoth(`æ±ºç€: ${reason}`, "sys");
    if(isHost) sync();
    showGameOver();
}

function showGameOver() {
    document.getElementById('game-over-modal').style.display = 'flex';
    const label = document.getElementById('winner-text');
    const isMyWin = (myRole === gameState.winner);
    if(isMyWin) {
        label.innerText = "ã‚ãªãŸã®å‹åˆ©ï¼";
        label.style.color = "#f1c40f";
    } else {
        label.innerText = "ã‚ãªãŸã¯æ•—åŒ—ã—ãŸâ€¦â€¦";
        label.style.color = "#e74c3c";
    }
}
// requestRestart é–¢æ•°å†…ï¼ˆãƒ›ã‚¹ãƒˆå´ã®å‡¦ç†ï¼‰
function requestRestart() {
    if(confirm("ãƒ«ãƒ¼ãƒ ã‚’ç¶­æŒã—ãŸã¾ã¾å†æˆ¦ã—ã¾ã™ã‹ï¼Ÿ")) {
        if(isHost) {
            gameState.started = false;
            gameState.gameOver = false;
            gameState.winner = null;
            gameState.p1 = null;
            gameState.p2 = null;
            gameState.turn = 1;
            gameState.ruleMode = null; // ãƒ«ãƒ¼ãƒ«ã‚‚ã‚¯ãƒªã‚¢ã™ã‚‹
            gameState.history = [];    // å±¥æ­´ã‚‚ã‚¯ãƒªã‚¢
            
            resetLocalStates();
            
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            document.getElementById('mode-selection-modal').style.display = 'flex';
            
            if(!isSolo) sync();
            updateUI();
        } else {
            send('ACTION', {type: 'RESTART'});
        }
    }
}
function resetLocalStates() { 
    myStyles=[]; oppStyles=[]; myReady=false; oppReady=false; 
    currentMode='IDLE'; selectedCards=[]; spellMainIdx=null; 
    turnModalShown = false; // ã“ã‚Œã‚’è¿½åŠ 
    document.getElementById('remaining-sp').innerText="4"; 
    document.getElementById('style-ready-btn').style.display='block'; 
    document.getElementById('waiting-msg').style.display='none'; 
}
function resetUIVisibility() { document.getElementById('game-board').style.display = 'none'; document.getElementById('game-controls').style.display = 'none'; document.getElementById('game-log').style.display = 'none'; document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
function sync() { if(isHost && !isSolo) send('SYNC', gameState); updateUI(); }
function send(t, p) { if(conn && conn.open) conn.send({type:t, payload:p}); }
function writeLog(m, t) { const l=document.getElementById('game-log'); const e=document.createElement('div'); e.className=`log-entry log-${t}`; e.innerText=`[${new Date().toLocaleTimeString()}] ${m}`; l.insertBefore(e, l.firstChild); }
function logToBoth(m, t) { writeLog(m, t); if(isHost && !isSolo) send('LOG', {msg:m, type:t}); }
function resetMode() { currentMode='IDLE'; selectedCards=[]; spellMainIdx=null; document.getElementById('mode-text').innerText=""; updateUI(); }
function setMode(m) {
    if(gameState.gameOver) return;
    const me = (myRole === 'p1' ? gameState.p1 : gameState.p2);
    const opp = (myRole === 'p1' ? gameState.p2 : gameState.p1);

    if (currentMode === m) {
        resetMode();
        return;
    }

    let requiredAP = 1;
    if (m === 'SUMMON') {
        if (opp.field.some(x => x.rank === 13) && opp.styles.includes('kingAura')) requiredAP = 2;
    } else if (m === 'ATTACK') {
        // ã€ä¿®æ­£ã€‘ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æŒã¡ã€ã‹ã¤å ´ã«JãŒã„ã‚Œã°ã€AP0ã§ã‚‚ãƒ¢ãƒ¼ãƒ‰ã¸ã®é€²å…¥ã‚’è¨±å¯ã™ã‚‹
        const hasJackOnField = me.field.some(c => c.rank === 11);
        if (hasJackOnField && me.styles.includes('assassinJ')) {
            requiredAP = 0; 
        } else {
            requiredAP = 1;
        }
    }

    if (me.ap < requiredAP) {
        logToBoth("APãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼", "sys");
        return;
    }

    currentMode = m;
    selectedCards = [];
    spellMainIdx = null;
    document.getElementById('mode-text').innerText = "ãƒ¢ãƒ¼ãƒ‰: " + m;
    updateUI();
}
function endTurn() { if(gameState.gameOver) return; if(isHost) { gameState.turn=(gameState.turn===1?2:1); startTurn(); } else send('ACTION', {type:'END_TURN'}); resetMode(); }

function executeDirectAttack() { requestAction('DIRECT', {idxs: selectedCards.map(s=>s.idx)}); resetMode(); }

function renderStyleChips(id, styles) { const c=document.getElementById(id); c.innerHTML=''; styles.forEach(sid=>{ const s=STYLES_DEF.find(x => x.id === sid); if(s){ const ch=document.createElement('div'); ch.className='style-chip'; ch.innerText=s.name; ch.title=s.desc; c.appendChild(ch); } }); }
function openRuleBook() { 
    window.open("rule.pdf", "_blank"); 
}
function createDeck(s) { let d=[]; s.forEach(su=>{ for(let r=1; r<=13; r++) d.push({suit:su, rank:r, red:(su==='H'||su==='D'), tapped:false}); }); d.push({suit:'J', rank:14, isJoker:true, red:null, tapped:false}); return d.sort(()=>Math.random()-0.5); }
function getCardName(c) { if(!c) return ""; if(c.isJoker) return "[JOK]"; return `[${SUITS[c.suit]}${c.rank===1?'A':(c.rank===11?'J':(c.rank===12?'Q':(c.rank===13?'K':c.rank)))}]`; }
function requestAction(type, params) { if(isHost) { executeAction(type, params); if(!isSolo) sync(); } else send('ACTION', {type, params}); }
function handleSpellFollowUp(card) {
    if(card.isJoker) {
        document.getElementById('joker-modal').style.display = 'flex';
    } else if(card.red === true) { // æ˜ç¤ºçš„ã« true ã‚’ç¢ºèª
        document.getElementById('red-spell-modal').style.display = 'flex';
    } else {
        // é»’ã‚¹ãƒšãƒ«ï¼ˆã“ã“ã«æ¥ã‚‹æ™‚ç‚¹ã§ç›¸æ‰‹ã«å…µå£«ãŒã„ã‚‹ã“ã¨ã¯ä¸Šè¨˜ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§ä¿è¨¼ï¼‰
        currentMode = 'SPELL_TARGET';
        document.getElementById('mode-text').innerText = "ç ´å£Šã™ã‚‹ç›¸æ‰‹å…µå£«ã‚’é¸æŠã—ã¦ãã ã•ã„";
    }
    updateUI();
}
function resolveJoker(choice) {
    document.getElementById('joker-modal').style.display = 'none';
    const opp = (myRole === 'p1' ? gameState.p2 : gameState.p1);
    
    if(choice === 'red') {
        document.getElementById('red-spell-modal').style.display = 'flex';
    } else {
        // é»’ã‚’é¸æŠ
        if(opp.field.length > 0) {
            currentMode = 'SPELL_TARGET';
            document.getElementById('mode-text').innerText = "ç ´å£Šã™ã‚‹ç›¸æ‰‹å…µå£«ã‚’é¸æŠã—ã¦ãã ã•ã„";
        } else {
            logToBoth("å¯¾è±¡ã¨ãªã‚‹ç›¸æ‰‹å…µå£«ãŒã„ãªã„ãŸã‚ã€åŠ¹æœã¯ç™ºå‹•ã—ã¾ã›ã‚“ã§ã—ãŸã€‚", "sys");
            resetMode();
        }
    }
    updateUI();
}
function resolveRedChoice(c) { document.getElementById('red-spell-modal').style.display='none'; if(c==='DRAW') { requestAction('SPELL_RED_RESOLVE', {choice:'DRAW'}); resetMode(); } else { const me=(myRole==='p1'?gameState.p1:gameState.p2); if(me.trash.filter(x=>!x.isJoker).length === 0) { requestAction('SPELL_RED_RESOLVE', {choice:'DRAW'}); resetMode(); } else showTrashModal(me.trash); } }
function showTrashModal(tr) { 
    const d=document.getElementById('trash-display'); 
    d.innerHTML=''; 
    tr.forEach((c,i)=>{ 
        if(c.isJoker) return; 
        const v=document.createElement('div'); 
        v.className=`card ${c.red?'red':''}`; 
        // ä¿®æ­£å‰: <div>${c.rank}</div>
        // ä¿®æ­£å¾Œ: <div>${getRankText(c.rank)}</div>
        v.innerHTML=`<div class="suit">${SUITS[c.suit]}</div><div>${getRankText(c.rank)}</div>`; 
        v.onclick=()=>{ 
            document.getElementById('trash-modal').style.display='none'; 
            requestAction('SPELL_RECOVER_FINISH',{trashIdx:i}); 
            resetMode(); 
        }; 
        d.appendChild(v); 
    }); 
    document.getElementById('trash-modal').style.display='flex'; 
}
function showBounceModal(fi) { const d=document.getElementById('bounce-display'); d.innerHTML=''; fi.forEach((c,i)=>{ const v=document.createElement('div'); v.className='card'; v.innerHTML=`<div class="suit">${SUITS[c.suit]}</div><div>${c.rank}</div>`; v.onclick=()=>{ document.getElementById('bounce-modal').style.display='none'; requestAction('BOUNCE',{idx:i}); resetMode(); }; d.appendChild(v); }); document.getElementById('bounce-modal').style.display='flex'; }

async function runAiTurn() {
    if(!isSolo || gameState.turn!==2 || gameState.gameOver) return;
    const ai=gameState.p2; const human=gameState.p1;
    const wait=(ms)=>new Promise(res=>setTimeout(res, ms));
    logToBoth("AIãŒæˆ¦ç•¥ã‚’ç·´ã£ã¦ã„ã¾ã™...", "ai");
    await wait(1000);

    // 1. ã‚¹ãƒšãƒ«ä½¿ç”¨ï¼šé»’ã‚¹ãƒšãƒ«ãŒã‚ã‚Œã°ã€ç›¸æ‰‹ã®å ´ã®ä¸­ã§æœ€ã‚‚ãƒ©ãƒ³ã‚¯ãŒé«˜ã„ã‚«ãƒ¼ãƒ‰ã‚’ç ´å£Š
    let blackSpells = ai.hand.filter(c => !c.red && !c.isJoker);
    if (blackSpells.length > 0 && ai.ap > 0 && human.field.length > 0) {
        let spell = blackSpells[0];
        let sortedHand = [...ai.hand].sort((a,b) => a.rank - b.rank);
        let costCard = sortedHand.find(c => c !== spell);
        if (costCard && costCard.rank >= spell.rank - 1) {
            executeAction('SPELL_MAIN', {idx: ai.hand.indexOf(spell), costIdxs: [{area:'hand', idx: ai.hand.indexOf(costCard)}]});
            let targetIdx = 0;
            let maxRank = -1;
            human.field.forEach((c, idx) => {
                let r = getEffectiveRank(c, human);
                if (r > maxRank) { maxRank = r; targetIdx = idx; }
            });
            executeAction('SPELL_BLACK_RESOLVE', {targetIdx: targetIdx});
            await wait(800);
        }
    }

    // 2. æ‹›é›†ï¼šæœ€å¤§ã¾ã§å±•é–‹
    while(ai.ap > 0 && ai.field.length < 4 && ai.hand.length > 0) {
        executeAction('SUMMON', {idx: 0, cost: 1});
        await wait(600);
    }

    // 3. æ”»æ’ƒãƒ•ã‚§ã‚¤ã‚º
    let attackers = ai.field.filter(c => !c.tapped);
    for (let striker of attackers) {
        if (ai.ap <= 0 || gameState.gameOver) break;
        let sIdx = ai.field.indexOf(striker);
        let strikerRank = getEffectiveRank(striker, ai);
        
        if (human.field.length === 0) {
            // A. ç›´æ¥æ”»æ’ƒï¼ˆ2ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‰
            executeAction('DIRECT', {idxs: [sIdx]});
            await wait(800);
        } else {
            // æ”»æ’ƒå¯¾è±¡ã‚’ã‚¹ã‚³ã‚¢ã§é¸å®š
            let bestTargetIdx = -1;
            let bestAction = null; // 'WIN', 'TIE', 'DIFF' (ç•°è‰²)

            // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ¢ã™
            human.field.forEach((h, hIdx) => {
                let hRank = getEffectiveRank(h, human);
                let sameColor = (h.red === striker.red);

                if (sameColor) {
                    // åŒè‰²ï¼šå‹ã¦ã‚‹ãªã‚‰æœ€å„ªå…ˆã€ç›¸æ‰“ã¡ã¯æ¬¡ç‚¹
                    if (strikerRank > hRank) {
                        if (bestAction !== 'WIN') { bestTargetIdx = hIdx; bestAction = 'WIN'; }
                    } else if (strikerRank === hRank) {
                        if (!bestAction || bestAction === 'DIFF') { bestTargetIdx = hIdx; bestAction = 'TIE'; }
                    }
                } else {
                    // ç•°è‰²ï¼šãƒ€ãƒ¡ãƒ¼ã‚¸ã¯0ã ãŒç›¸æ‰‹ã‚’ç¢ºå®Ÿã«ç ´å£Šã§ãã‚‹ï¼ˆé™¤å»ï¼‰
                    // ãŸã ã—ç›¸æ‰‹ãŒã€Œãƒãƒªã‚«ã‚¿ã‚·ãƒƒã‚¯ã‚¹ã€ã‹ã¤6ã®å ´åˆã¯ç•°è‰²ã§å£Šã›ãªã„ã®ã§é™¤å¤–
                    let isBarikata = (h.rank === 6 && human.styles.includes('barikata6'));
                    if (!isBarikata) {
                        // åŒè‰²ã§å‹ã¦ã‚‹è¦‹è¾¼ã¿ãŒãªã„å ´åˆã®ã¿ã€ç•°è‰²æˆ¦é—˜ã‚’æ¤œè¨
                        if (!bestAction) {
                            // ç•°è‰²æˆ¦é—˜ã®ä¸­ã§ã¯ã€ç›¸æ‰‹ã®ãƒ©ãƒ³ã‚¯ãŒé«˜ã„ã‚‚ã®ã‚’å„ªå…ˆã—ã¦é™¤å»
                            if (bestTargetIdx === -1 || hRank > getEffectiveRank(human.field[bestTargetIdx], human)) {
                                bestTargetIdx = hIdx;
                                bestAction = 'DIFF';
                            }
                        }
                    }
                }
            });

            if (bestTargetIdx !== -1) {
                executeAction('COMBAT', {atkIdxs: [sIdx], defIdx: bestTargetIdx, apCost: 1});
                await wait(800);
            } else {
                // å‹ã¦ã‚‹è¦‹è¾¼ã¿ã‚‚ã€å®‰å…¨ãªé™¤å»ï¼ˆç•°è‰²ï¼‰ã‚‚ã§ããªã„å ´åˆã¯æ”»æ’ƒã—ãªã„ï¼ˆè‡ªçˆ†å›é¿ï¼‰
                logToBoth(`AI: ${getCardName(striker)} ã¯è¿”ã‚Šè¨ã¡ã‚’é¿ã‘ã‚‹ãŸã‚å¾…æ©Ÿã€‚`, "ai");
            }
        }
    }

    await wait(500);
    endTurn();
}
function getEffectiveRank(c, p) { if(!c) return 0; if(c.isJoker) return 14; let r = c.rank; if(r===5 && p.styles.includes('bond5') && p.field.filter(x=>x.rank===5).length >= 2) r=10; if(p.styles.includes('suitSync') && p.field.length === 4 && p.field.every(x=>x.suit===p.field[0].suit)) r+=2; return r; }
function renderCards(id, cards, isBack, owner, area, pObj) { const container = document.getElementById(id); container.innerHTML = ''; if(!cards) return; cards.forEach((c, i) => { const div = document.createElement('div'); div.className = isBack ? 'card back' : `card ${c.red ? 'red' : ''} ${c.isJoker ? 'colorless' : ''} ${c.tapped ? 'tapped' : ''}`; if(!isBack) { if(owner === 'me' && area === 'hand' && i === spellMainIdx) div.classList.add('spell-main'); if(owner === 'me' && selectedCards.some(s => s.idx === i && s.area === area)) div.classList.add('selected'); if(owner === 'opp' && area === 'field' && (currentMode === 'ATTACK' || currentMode === 'SPELL_TARGET')) div.classList.add('can-target'); let rank = getEffectiveRank(c, pObj); div.innerHTML = `<div class="suit">${SUITS[c.suit]}</div><div>${getRankText(c.rank)}</div>`; } div.onclick = () => handleCardClick(owner, area, i); container.appendChild(div); }); }
</script>
</body>
</html>
